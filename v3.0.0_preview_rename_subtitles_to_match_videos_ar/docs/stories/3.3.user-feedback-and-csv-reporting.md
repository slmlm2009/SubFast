# Story 3.3: Implement User Feedback and CSV Reporting

## Status
In Progress

## Story

**As a** user,  
**I want** to receive clear feedback during processing and optionally export a detailed report,  
**so that** I can track what was done and troubleshoot any issues.

## Acceptance Criteria

1. **BOTH SCRIPTS:** Display SubFast branded banner at startup (hardcoded ASCII art)
2. Real-time console output shows which file is currently being processed
3. Success/failure status is displayed for each operation
4. The final output filename is displayed after each successful merge
5. A CSV report (`embedding_report.csv`) can be exported with processing details
6. **CRITICAL:** Implement smart console behavior for **BOTH** scripts - renaming AND embedding (if code executed without major exit code, console window automatically closes; if not, it remains active and waits for key input to close)
7. The CSV includes: original filename, subtitle filename, output filename, status, timestamp
8. CSV export is configurable via the `config.ini` file (enabled by default, disabled in case of fall-off)
9. The CSV uses the same structure as the renaming script's `export_analysis_to_csv` function
10. The CSV header includes the SubFast banner (as comments with # prefix)
11. Error details are included in the CSV for failed operations
12. The CSV is saved in the same directory as the processed files
13. A summary is displayed at the top showing total files, successes, failures, and processing time
14. **CRITICAL:** Having a configurable option to have the console window remain open at completion until a key is pressed - this is **shared for BOTH scripts** - renaming AND embedding (disabled by default, will not affect smart console behavior)

## Dev Notes

### Previous Story Insights

**From Story 3.2 (Windows Context Menu Integration):**
- Console window appears automatically when scripts are invoked from context menu
- Users expect to see processing progress in real-time
- Console visibility is important for troubleshooting
- Scripts already validate mkvmerge.exe presence on startup
- Integration with Windows Shell requires proper exit codes

**From Story 3.1 (Configuration File Handling):**
- Configuration system is unified across both scripts
- `embedding_report` setting already exists in config.ini (NEW key name)
- Configuration loading includes fallback defaults
- Both scripts share configuration patterns for consistency

### Technical Context

**SubFast Branded Banner:**

**CRITICAL: This banner must appear in BOTH scripts at startup and in CSV headers**

Hardcoded banner constant (add to top of both scripts):
```python
BANNER = """==========================================
   ____        _     _____          _   
  / ___| _   _| |__ |  ___|_ _  ___| |_ 
  \___ \| | | | '_ \| |_ / _` |/ __| __|
   ___) | |_| | |_) |  _| (_| |\__ \ |_ 
  |____/ \__,_|_.__/|_|  \__,_||___/\__|
                                        
   Fast subtitle renaming and embedding

==========================================
"""

CSV_BANNER = """# ==========================================
#    ____        _     _____          _   
#   / ___| _   _| |__ |  ___|_ _  ___| |_ 
#   \___ \| | | | '_ \| |_ / _` |/ __| __|
#    ___) | |_| | |_) |  _| (_| |\__ \ |_ 
#   |____/ \__,_|_.__/|_|  \__,_||___/\__|
#                                         
#    Fast subtitle renaming and embedding
# 
# ==========================================
#
"""

def print_banner():
    """Display SubFast branded banner at startup"""
    print(BANNER)
```

Usage:
- Call `print_banner()` at the very start of `main()` in both scripts
- Use `CSV_BANNER` as the first part of CSV report headers

[Source: docs/resources/CLI_LOGO.txt - approved banner design]

---

**๐ด CRITICAL REQUIREMENT: Smart Console Behavior MUST be IDENTICAL in BOTH Scripts**

This story implements smart console behavior that MUST work exactly the same way in:
1. `embed_subtitles_to_match_videos_ar.py` (embedding script)
2. `rename_subtitles_to_match_videos_ar.py` (renaming script)

Both scripts must:
- Share the same `keep_console_open` config setting from `[General]` section
- Use identical exit code logic
- Implement the same keypress waiting behavior
- Close automatically on success (unless `keep_console_open = true`)
- Stay open on errors for user to see error messages

**Console Output Patterns:**

Current state analysis:
- Embedding script uses `print()` statements with `[INFO]`, `[WARNING]`, `[ERROR]` prefixes
- Configuration loading already provides console feedback
- Need to add per-file processing progress messages
- Summary output should follow established INFO/WARNING/ERROR pattern

[Source: `embed_subtitles_to_match_videos_ar.py` lines 136-346 - existing console output patterns]

**CSV Export Architecture:**

The renaming script already has a comprehensive `export_analysis_to_csv()` function that creates:
- Summary header with timestamp, config, and statistics
- CSV table showing original filenames, detected episodes, and actions
- Match summary showing successful pairings
- Missing matches and unidentified files

The embedding script should follow the same structure:
- Summary section: timestamp, total files, successes, failures, execution time
- Details table: original_video, subtitle_file, output_file, status, error_details (if failed), timestamp
- Configuration summary: mkvmerge path, language code, default_flag setting

[Source: `rename_subtitles_to_match_videos_ar.py` lines 881-1053 - export_analysis_to_csv function]

**Exit Code Handling:**

Python script exit codes (already defined in embedding script):
```python
EXIT_SUCCESS = 0           # All operations completed successfully
EXIT_FATAL_ERROR = 1       # Fatal error: mkvmerge not found, config invalid, etc.
EXIT_PARTIAL_FAILURE = 2   # Some operations failed, some succeeded
EXIT_COMPLETE_FAILURE = 3  # All operations attempted failed
```

[Source: `embed_subtitles_to_match_videos_ar.py` lines 40-43 - exit codes]

**Smart Console Behavior Logic:**

**CRITICAL: This logic must be IDENTICAL in BOTH renaming AND embedding scripts**

Windows console behavior:
- If script exits with code 0 (success): Console closes automatically
- If script exits with non-zero code: Console remains open showing error
- Additional option: `keep_console_open` config setting to always wait for keypress

Implementation approach (apply to BOTH scripts):
```python
# At end of main():
if exit_code != EXIT_SUCCESS or config.get('keep_console_open', False):
    input("\nPress Enter to close this window...")
sys.exit(exit_code)
```

[Source: Architecture Document ยง2.1 - Windows Subprocess Execution Guidelines]

**Configuration Settings:**

Already implemented in config.ini:
```ini
[Embedding]
embedding_report = true   # Enable/disable CSV export
```

New setting needed:
```ini
[General]
keep_console_open = false  # Shared between both scripts
```

[Source: `config.ini` and Story 3.1 unified configuration]

### File Locations

**Files to Modify:**
- `rename_subtitles_to_match_videos_ar/embed_subtitles_to_match_videos_ar.py` - Add CSV export, console feedback, AND smart console behavior
- `rename_subtitles_to_match_videos_ar/rename_subtitles_to_match_videos_ar.py` - Add smart console behavior (same implementation as embedding script)
- `rename_subtitles_to_match_videos_ar/config.ini` - Add `keep_console_open` setting to [General] section
- `rename_subtitles_to_match_videos_ar/CONFIGURATION_README.md` - Document new settings

**Files Referenced:**
- `rename_subtitles_to_match_videos_ar/rename_subtitles_to_match_videos_ar.py` - Reference for `export_analysis_to_csv` structure

[Source: Architecture Document ยง6 - Project Structure]

### Testing Requirements

**Unit Tests Required:**
- Test CSV generation with successful operations only
- Test CSV generation with mixed success/failure
- Test CSV generation with all failures
- Test console output formatting
- Test exit code logic (success, partial failure, complete failure)
- Test keep_console_open config setting

**Integration Tests Required:**
- Test CSV export with real file processing
- Test console behavior with different exit codes
- Test configuration loading for new settings
- Verify both scripts share console behavior consistently

[Source: Architecture Document ยง5 - Testing Strategy]

### Technical Constraints

**Python Standard Library:**
- Use built-in `csv` module for CSV generation
- Use `datetime` module for timestamps (already imported)
- Use `input()` for keypress waiting

**Performance Considerations:**
- CSV writing should not significantly impact processing time
- Console output should be unbuffered for real-time feedback (`flush=True` if needed)

**Compatibility:**
- Must work with Windows 10 and Windows 11
- Console behavior must work when invoked from context menu
- CSV must be UTF-8 encoded to handle international filenames

[Source: Epic 3 NFR2 - Platform Compatibility]

## Tasks / Subtasks

### Task 1: Add SubFast Branded Banner - **BOTH SCRIPTS** (AC: 1, 10)

**CRITICAL: This task applies to BOTH renaming AND embedding scripts**

- [x] **BOTH SCRIPTS:** Add hardcoded `BANNER` constant at top of script (after imports)
- [x] **BOTH SCRIPTS:** Add hardcoded `CSV_BANNER` constant (banner with # prefix for CSV comments)
- [x] **BOTH SCRIPTS:** Create `print_banner()` function that prints `BANNER`
- [x] **BOTH SCRIPTS:** Call `print_banner()` at the very start of `main()` function (before any other output)
- [ ] **EMBEDDING SCRIPT:** Update CSV export function to include `CSV_BANNER` at start of CSV header
- [ ] **RENAMING SCRIPT:** Update CSV export function to include `CSV_BANNER` at start of CSV header
- [x] Test banner displays correctly in console for both scripts
- [ ] Test banner appears in CSV reports for both scripts
- [x] Verify banner formatting is correct (no encoding issues with box-drawing characters)

### Task 2: Implement Console Feedback for Embedding Script (AC: 2, 3, 4, 13)

- [x] Add per-file processing messages showing current operation (already implemented)
- [x] Display success/failure status after each merge attempt (already implemented)
- [x] Show final output filename after successful operations (already implemented)
- [x] Add summary output at end: total files, successes, failures, processing time (already implemented via display_batch_summary)
- [x] Ensure console messages use consistent `[INFO]`, `[ERROR]`, `[SUCCESS]` prefixes (already implemented)
- [x] Test console output with multiple files (success and failure cases) (verified via existing code)

### Task 3: Implement CSV Export for Embedding Script (AC: 5, 7, 8, 9, 10, 11, 12)

- [ ] Create `export_embedding_report_to_csv()` function following renaming script structure
- [ ] CSV header section: Start with `CSV_BANNER`, then timestamp, config summary, statistics (total, success, fail, time)
- [ ] CSV details table: original_video, subtitle_file, output_file, status, error_details, timestamp
- [ ] Handle error details: capture mkvmerge error output for failed operations
- [ ] CSV filename: `embedding_report.csv` in same directory as processed files
- [ ] Check `embedding_report` config setting before generating CSV
- [ ] Use UTF-8 encoding for international filename support
- [ ] Add unit test: CSV generation with successful operations
- [ ] Add unit test: CSV generation with mixed success/failure
- [ ] Add unit test: CSV generation with all failures

### Task 4: Implement Smart Console Behavior - **BOTH SCRIPTS** (AC: 6, 14)

**CRITICAL: This task applies to BOTH renaming AND embedding scripts with IDENTICAL implementation**

- [ ] Add `keep_console_open` setting to `[General]` section of config.ini template
- [ ] **EMBEDDING SCRIPT:** Update `create_default_config()` to include `keep_console_open = false` in [General] section
- [ ] **RENAMING SCRIPT:** Update `create_default_config_file()` to include `keep_console_open = false` in [General] section
- [ ] **BOTH SCRIPTS:** Load `keep_console_open` setting from `[General]` section (shared setting)
- [ ] **BOTH SCRIPTS:** Implement identical smart console logic at end of `main()`:
  - If exit code is non-zero OR `keep_console_open` is true: wait for keypress
  - Otherwise: exit immediately
- [ ] **BOTH SCRIPTS:** Use `input("\nPress Enter to close this window...")` for keypress waiting
- [ ] **BOTH SCRIPTS:** Ensure proper exit codes are used throughout:
  - Embedding: EXIT_SUCCESS, EXIT_FATAL_ERROR, EXIT_PARTIAL_FAILURE, EXIT_COMPLETE_FAILURE
  - Renaming: Define same exit codes if not already present
- [ ] Test smart console behavior with Windows context menu invocation for BOTH scripts
- [ ] Add unit test: exit code logic for different scenarios (both scripts)
- [ ] Add integration test: console behavior with real execution (both scripts)
- [ ] **VERIFICATION:** Confirm both scripts behave identically in all console scenarios

### Task 5: Update Documentation (AC: 14)

- [ ] Update CONFIGURATION_README.md with `keep_console_open` setting explanation
- [ ] Document `embedding_report` setting (already exists, ensure documented)
- [ ] Add examples showing console output behavior
- [ ] Document CSV report structure and location
- [ ] Add troubleshooting section for console behavior

### Task 6: Integration Testing and Verification (AC: All)

- [ ] Test end-to-end: embed subtitles with CSV export enabled
- [ ] Test end-to-end: embed subtitles with CSV export disabled
- [ ] **BOTH SCRIPTS:** Test console closes automatically on success (default behavior)
- [ ] **BOTH SCRIPTS:** Test console stays open on errors (smart behavior)
- [ ] **BOTH SCRIPTS:** Test console stays open when `keep_console_open = true`
- [ ] Verify CSV report is created in correct location
- [ ] Verify CSV contains all required fields and accurate data
- [ ] **CRITICAL:** Test with BOTH scripts to ensure IDENTICAL console behavior in all scenarios
- [ ] Verify existing integration tests still pass
- [ ] Test from Windows context menu invocation

## Testing

**Manual Testing Steps:**
1. Enable `embedding_report = true` in config.ini
2. **EMBEDDING SCRIPT:** Run embedding script on folder with multiple video/subtitle pairs
3. **EMBEDDING SCRIPT:** Verify console shows real-time progress for each file
4. **EMBEDDING SCRIPT:** Verify `embedding_report.csv` is created in the same folder
5. Open CSV and verify all fields are populated correctly
6. **EMBEDDING SCRIPT:** Test error scenario: remove mkvmerge.exe temporarily
7. **EMBEDDING SCRIPT:** Verify console stays open on error (smart behavior)
8. **BOTH SCRIPTS:** Test `keep_console_open = true` setting
9. **BOTH SCRIPTS:** Verify console waits for keypress on success when setting enabled
10. **BOTH SCRIPTS:** Test console closes automatically on success when setting disabled
11. **RENAMING SCRIPT:** Verify console behavior matches embedding script exactly
12. **CRITICAL:** Confirm IDENTICAL console behavior in all scenarios for BOTH scripts

**Acceptance Validation:**
- AC1: SubFast branded banner displays in console and CSV for both scripts โ
- AC2-4: Console output is clear, real-time, and informative โ
- AC5,7-12: CSV export works correctly with all required fields and banner โ
- AC6: Smart console behavior works (auto-close on success, stay open on error) โ
- AC13: Summary statistics are displayed โ
- AC14: `keep_console_open` config option works in both scripts โ

## Dev Agent Record

### Agent Model Used
<!-- Developer: Update this when implementing -->

### Debug Log References
<!-- Developer: Add references to debug logs during implementation -->

### Completion Notes
<!-- Developer: Add completion notes here -->

### File List
<!-- Developer: List all created, modified, and deleted files -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story draft created from Epic 3 requirements | Bob (Scrum Master) |
