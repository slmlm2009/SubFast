# Story 6.6: Add 7 New Patterns + Pattern Reordering

**Epic:** 6 - Testing Infrastructure  
**Status:** DONE  
**Priority:** High  
**Story Points:** 5

---

## Story

As a SubFast developer,  
I want to add 7 new episode pattern variations and reorder patterns for optimal matching,  
So that SubFast supports more naming conventions and matches patterns from most specific to least specific.

---

## Acceptance Criteria

### AC1: New Pattern IDs Added
- ✅ Pattern 27: `[##]` format (bracket-enclosed episode, assumes S01)
- ✅ Pattern 28: `_##` format (underscore prefix, assumes S01, LAST pattern)

### AC2: Pattern Variations Added
- ✅ Pattern 1 VAR6: `S## Episode ##` (full Episode word)
- ✅ Pattern 4 VAR4: `S##.E##` (dot separator)
- ✅ Pattern 4 VAR5: `S##_E##` (underscore separator)
- ✅ Pattern 5 VAR4: `S## EP##` (space, no dash)
- ✅ Pattern 15 VAR4: `Season## Episode ##` (optional spaces, space/underscore separator)

### AC3: Pattern Reordering for Specificity
- ✅ Swapped Pattern 23 ↔ 24 (Season # Ep # now before Ep##)
- ✅ Moved Pattern 20 (E##) to Pattern 25
- ✅ Patterns 25-28 shifted to 26-29
- ✅ Pattern engine updated with new order
- ✅ Test directories renamed to match new IDs

### AC4: All Tests Pass
- ✅ 128/128 total tests pass (100%)
- ✅ 93/93 pattern variations pass (100%)
- ✅ No regression in existing patterns

### AC5: Documentation Updated
- ✅ Pattern reference guide updated with all 28 patterns
- ✅ Reordering rationale documented
- ✅ Pattern 22 noted as unassigned/reserved

---

## Tasks / Subtasks

- [x] **Task 1:** Add 7 regex patterns to pattern_engine.py
  - [x] Pattern 1a: S## Episode ##
  - [x] Pattern 4a: S##.E##
  - [x] Pattern 4b: S##_E##
  - [x] Pattern 5a: S## EP##
  - [x] Pattern 15a: Season## Episode ##
  - [x] Pattern 27: [##]
  - [x] Pattern 28: _##

- [x] **Task 2:** Add pattern definitions to JSON
  - [x] Add variations to existing patterns (1, 4, 5, 15)
  - [x] Add new Pattern 27 definition
  - [x] Add new Pattern 28 definition
  - [x] Update metadata (total_patterns = 28)

- [x] **Task 3:** Generate test files
  - [x] Regenerate Pattern 1 test files (6 variations)
  - [x] Regenerate Pattern 4 test files (5 variations)
  - [x] Regenerate Pattern 5 test files (4 variations)
  - [x] Regenerate Pattern 15 test files (4 variations)
  - [x] Generate Pattern 27 test files (3 variations)
  - [x] Generate Pattern 28 test files (3 variations)

- [x] **Task 4:** Reorder patterns for specificity
  - [x] Swap Pattern 23 ↔ 24 in pattern_definitions.json
  - [x] Move Pattern 20 (E##) to Pattern 25
  - [x] Shift Pattern 25-28 to 26-29
  - [x] Rename test directories to match new IDs
  - [x] Update pattern_engine.py with new order

- [x] **Task 5:** Run tests and verify
  - [x] Run pattern integration tests (93/93 pass)
  - [x] Run full test suite (128/128 pass)
  - [x] Verify no regression

- [x] **Task 6:** Update documentation
  - [x] Update header (28 patterns total)
  - [x] Update Pattern 1 documentation
  - [x] Update Pattern 4 documentation
  - [x] Update Pattern 5 documentation
  - [x] Update Pattern 15 documentation
  - [x] Add Pattern 27 documentation
  - [x] Add Pattern 28 documentation (LAST)
  - [x] Add Pattern 29 documentation (was 28)
  - [x] Document reordering with rationale

---

## Dev Notes

### Pattern Specifications

**New Pattern IDs:**

**Pattern 27: [##]**
- Format: `[07]` → S01E07
- Regex: `\[(\d{1,2})\](?![a-zA-Z0-9])`
- Hardening: Blocks `[10bit]`, `[1080p]`, `[x265]` (negative lookahead)
- Example: `[VCB-Studio] IS [07].mkv` → S01E07 ✅

**Pattern 28: _##**
- Format: `Show_09.mkv` → S01E09
- Regex: `_(?:1[0-8]\d{2}|\d{1,3})(?![a-zA-Z0-9])`
- Hardening: Same as Pattern 26/27 (blocks _1080p, years 1900+)
- Example: `[DB]Maoyuu_09.mkv` → S01E09 ✅

**Quick Win Variations:**

1. **S## Episode ##** - Full Episode word (Pattern 1 VAR6)
2. **S##.E##** - Dot separator (Pattern 4 VAR4)
3. **S##_E##** - Underscore separator (Pattern 4 VAR5)
4. **S## EP##** - Space, no dash (Pattern 5 VAR4)
5. **Season## Episode ##** - Optional spaces with space/underscore separator (Pattern 15 VAR4)

### Pattern Reordering Rationale

**Problem:** Generic patterns were matching before specific patterns, causing false positives.

**Solution:** Reorder patterns from most specific to least specific:

**Swap Pattern 23 ↔ 24:**
- **Before:** Pattern 23 = Ep##, Pattern 24 = Season # Ep #
- **After:** Pattern 23 = Season # Ep #, Pattern 24 = Ep##
- **Rationale:** "Season # Ep #" is MORE specific (has Season keyword) than just "Ep##"

**Move E## from 20 to 25:**
- **Before:** Pattern 20 = E## (generic)
- **After:** Pattern 25 = E## (after more specific patterns)
- **Rationale:** E## is very generic, should match after patterns with more context (Season keywords, etc.)

**Final Order (20-29):**
- Pattern 20: Season #.Ep # ← Specific
- Pattern 21: Season#.Ep# ← Specific
- Pattern 22: (unassigned/reserved)
- Pattern 23: Season # Ep # ← More specific
- Pattern 24: Ep## ← Less specific
- Pattern 25: E## ← Generic
- Pattern 26: ## - ## ← Very generic
- Pattern 27: - ## ← Very generic
- Pattern 28: [##] ← Very generic
- Pattern 29: _## ← LAST (most permissive)

### Implementation Details

**Files Modified:**

1. **Pattern Engine:**
   - `subfast/scripts/common/pattern_engine.py`
   - Added 7 new regex patterns
   - Reordered patterns 23-29

2. **Test Data:**
   - `tests/fixtures/pattern_definitions.json`
   - Added Pattern 27, 28 definitions
   - Added 5 variations to existing patterns
   - Total patterns: 28 (gap at ID 22)

3. **Test Files:**
   - Generated 46 new test files
   - Regenerated 30 existing test files
   - Renamed directories for reordered patterns

4. **Documentation:**
   - `tests/1- Renaming/episode_patterns_guide.md`
   - Updated all 28 patterns with reordering notes

5. **Helper Scripts:**
   - `add_patterns_story66.py` - Pattern addition automation
   - `reorder_patterns_fixed.py` - Pattern reordering automation
   - `regenerate_test_files.py` - Test file regeneration

---

## Testing

### Test Coverage

**Integration Tests:**
- Total Patterns: 28
- Total Variations: 93 (+11 from Story 6.6)
- Passed: 93/93 (100%)
- Failed: 0

**Full Test Suite:**
- Total Tests: 128
- Passed: 128/128 (100%)
- Unit Tests: 35/35
- Integration Tests: 93/93

### Test Verification

All test scenarios verified:

**Pattern 27 Tests:**
- ✅ `[VCB-Studio] IS [07].mkv` → S01E07
- ✅ `Show.[12].720p.mkv` → S01E12
- ✅ `Series [5] Episode.mkv` → S01E05
- ❌ `Show[10bit].mkv` → No match (hardening works)

**Pattern 28 Tests:**
- ✅ `[DB]Maoyuu_09.mkv` → S01E09
- ✅ `Show_15.mkv` → S01E15
- ✅ `Example_3.720p.mkv` → S01E03
- ❌ `Video_1080p.mkv` → No match (hardening works)

**Quick Win Variations:**
- ✅ S## Episode ## working (Pattern 1 VAR6)
- ✅ S##.E## working (Pattern 4 VAR4)
- ✅ S##_E## working (Pattern 4 VAR5)
- ✅ S## EP## working (Pattern 5 VAR4)
- ✅ Season## Episode ## working (Pattern 15 VAR4)

**Pattern Reordering:**
- ✅ Season # Ep # matches before Ep##
- ✅ E## moved to Pattern 25 (after specific patterns)
- ✅ No regression in existing patterns

---

## Dev Agent Record

### Agent Model Used
Claude 3.7 Sonnet (Droid CLI)

### Implementation Summary

**Story 6.6 completed successfully with:**
- 7 new pattern variations added
- 2 new pattern IDs created (27, 28)
- Pattern reordering implemented for better specificity
- All 128 tests passing (100%)

**Time Taken:** ~55 minutes (pattern addition + reordering)

**Key Decisions:**
1. Added quick-win variations to existing patterns (not new IDs)
2. Implemented pattern reordering based on specificity
3. Pattern 22 left unassigned (gap in sequence is acceptable)
4. Hardening applied to Pattern 27 and 28 (same as 26)

### Completion Notes

**What Worked Well:**
- Helper functions streamlined pattern addition
- Automated test file generation worked perfectly
- Pattern reordering script handled ID shifting cleanly
- All hardening protections working as expected

**Challenges Encountered:**
- Initial reordering script had ID conflict (fixed with reorder_patterns_fixed.py)
- Pattern 23 test directory had mixed files (cleaned and regenerated)
- Pattern engine comments needed updating for new pattern numbers

**Improvements Made:**
- Pattern reference guide now includes reordering rationale
- Pattern 22 gap explicitly documented
- All pattern hardening features documented

### File List

**Modified Files:**
- `subfast/scripts/common/pattern_engine.py` - Added 7 patterns, reordered 23-29
- `tests/fixtures/pattern_definitions.json` - Added Pattern 27, 28 + 5 variations
- `tests/1- Renaming/episode_patterns_guide.md` - Updated all 28 patterns
- Test directories renamed: 20→25, 21→20, 22→21, 23↔24, 25-28→26-29

**Created Files:**
- `add_patterns_story66.py` - Pattern addition script
- `reorder_patterns_fixed.py` - Pattern reordering script
- `regenerate_test_files.py` - Test file regeneration script
- `docs/stories/6.6.add-7-new-patterns.md` - This story file

**Test Files:**
- 46 new test files generated (Pattern 27, 28 + variations)
- 30 test files regenerated (Patterns 1, 4, 5, 15, 20, 21, 23, 24, 25)

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-01-17 | Story created and implemented | Developer (James) |
| 2025-01-17 | Added 7 patterns (2 new IDs + 5 variations) | Developer (James) |
| 2025-01-17 | Pattern reordering implemented | Developer (James) |
| 2025-01-17 | All tests passing (128/128) | Developer (James) |
| 2025-01-17 | Documentation updated | Developer (James) |
| 2025-01-17 | Story marked Ready for Review | Developer (James) |

---

## QA Results

_Awaiting QA review..._

---

**Story Status:** ✅ Ready for Review  
**All Tests:** 128/128 PASSED (100%)  
**Total Patterns:** 28 (was 26, +2 new IDs)  
**Total Variations:** 93 (was 82, +11 new)
