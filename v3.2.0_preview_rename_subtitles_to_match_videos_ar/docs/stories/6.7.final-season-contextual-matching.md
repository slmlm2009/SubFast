# Story 6.7: FINAL SEASON Contextual Matching

**Epic:** 6 - Testing Infrastructure  
**Status:** Ready for Review  
**Priority:** Medium  
**Story Points:** 8

---

## Story

As a SubFast user,  
I want subtitle files with "FINAL SEASON" in their names to automatically match the season number from corresponding video files,  
So that final season episodes are correctly matched without manually adding season numbers to subtitle filenames. The same if switched the pattern between the videos and subtitles as well

---

## Acceptance Criteria

### AC1: FINAL SEASON Keyword Detection
- ✅ Pattern 29 detects "FINAL SEASON" (case insensitive) in filenames
- ✅ Regex: `r'final\s+season'` (allows single space between words)
- ✅ Detected in both subtitle and video filenames
- ✅ Works with various separators: dots, spaces, underscores

### AC2: Subtitle → Video Season Inference
- ✅ When subtitle contains "FINAL SEASON" and has no season detected (defaults to S01)
- ✅ And video file has explicit season (e.g., S08)
- ✅ Subtitle season is inferred from video season
- ✅ Episode number is preserved from subtitle extraction
- ✅ Example: `Boku no Hero Academia FINAL SEASON - 01.ass` + `My.Hero.Academia.S08E01.mkv` → Subtitle treated as S08E01

### AC3: Video → Subtitle Season Inference
- ✅ When video contains "FINAL SEASON" and has no season detected (defaults to S01)
- ✅ And subtitle file has explicit season (e.g., S08)
- ✅ Video season is inferred from subtitle season
- ✅ Episode number is preserved from video extraction
- ✅ Example: `My.Hero.Academia.FINAL.SEASON.01.mkv` + `Boku no Hero Academia S08E01.ass` → Video treated as S08E01

### AC4: Matching Logic Enhancement
- ✅ `match_subtitle_to_video()` function enhanced with FINAL SEASON logic
- ✅ Season inference only applies when detected season is 1 (default)
- ✅ Episode numbers must still match for pairing
- ✅ Normal matching behavior preserved when FINAL SEASON not present

### AC5: Edge Cases Handled
- ✅ Both files have "FINAL SEASON": No inference, match normally
- ✅ Both files have explicit seasons: No inference, match normally
- ✅ Neither file has "FINAL SEASON": No inference, match normally
- ✅ Multiple videos in folder with different seasons: Inference per pair
- ✅ "FINAL SEASON" in path/folder name (not filename): Ignored

### AC6: Tests Pass
- ✅ Unit tests for FINAL SEASON keyword detection
- ✅ Integration tests with real-world example filenames
- ✅ Test case: My Hero Academia S08 + FINAL SEASON subtitles
- ✅ Edge case tests for all scenarios in AC5
- ✅ No regression in existing pattern matching

---

## Tasks / Subtasks

- [x] **Task 1:** Add FINAL SEASON detection helper
  - [x] Create `detect_final_season_keyword()` in pattern_engine.py
  - [x] Regex: `r'final[.\s_-]+season'` (case insensitive, multiple separators)
  - [x] Return True/False if keyword found in filename (not path)
  - [x] Unit test: Positive and negative cases (3 tests, all passing)

- [x] **Task 2:** Enhance match_subtitle_to_video() function
  - [x] Add FINAL SEASON detection for both files
  - [x] Implement Case 1: Subtitle has FINAL SEASON, video has season
  - [x] Implement Case 2: Video has FINAL SEASON, subtitle has season
  - [x] Season inference only when detected season == 1
  - [x] Preserve episode number from original extraction
  - [x] Update function docstring with FINAL SEASON behavior
  - [x] Unit tests: 8 tests covering all cases and edge cases (all passing)

- [x] **Task 3:** Update pattern_engine.py documentation
  - [x] Add Pattern 29 comment block (contextual, not regex)
  - [x] Document FINAL SEASON inference logic
  - [x] Add usage examples in comments
  - [x] Note that this is NOT a traditional pattern

- [x] **Task 4:** Add unit tests
  - [x] Test `detect_final_season_keyword()` function (3 tests)
  - [x] Test positive: "FINAL SEASON", "Final Season", "final season"
  - [x] Test negative: "FINALS", "SEASONAL", no keyword
  - [x] Test Case 1: Sub FINAL → infer from video
  - [x] Test Case 2: Video FINAL → infer from subtitle
  - [x] Test edge cases (both FINAL, both explicit, etc.) - 8 matching tests total

- [x] **Task 5:** Add integration tests
  - [x] Create My Hero Academia test scenario (AC2 example)
  - [x] Video: `My.Hero.Academia.S08E01.mkv`
  - [x] Subtitle: `[Heroacainarabic] Boku no Hero Academia FINAL SEASON - 01.ass`
  - [x] Added to `pattern_definitions.json` as Pattern 30
  - [x] Test multiple episodes (E01, E02) - VAR1, VAR2
  - [x] Test both directions (sub FINAL + video FINAL) - VAR1-VAR5
  - [x] Test edge case (both FINAL) - VAR6
  - [x] Generated 12 test files (6 variations × 2 files)
  - **NOTE:** Integration requires `match_subtitle_to_video()` usage in rename/embed scripts

- [x] **Task 6:** Update documentation
  - [x] Add Pattern 30 to episode_patterns_guide.md
  - [x] Document as "Contextual Pattern" (not regex)
  - [x] Include FINAL SEASON examples with My Hero Academia scenario
  - [x] Note inference behavior and limitations
  - [x] Update pattern count (30 patterns: 29 regex + 1 contextual)

---

## Dev Notes

### FINAL SEASON Contextual Logic

**Pattern 29: FINAL SEASON (Contextual)**

This is NOT a traditional regex pattern. It's a **contextual matching enhancement** that infers season numbers when "FINAL SEASON" keyword is detected.

**Detection:**
```python
def detect_final_season_keyword(filename: str) -> bool:
    """
    Detect if 'FINAL SEASON' keyword exists in filename (case insensitive).
    
    Args:
        filename (str): Filename only (not full path)
    
    Returns:
        bool: True if keyword found, False otherwise
    """
    import re
    return bool(re.search(r'final\s+season', filename, re.IGNORECASE))
```

**Matching Logic:**

```python
def match_subtitle_to_video(subtitle_file: str, video_file: str) -> bool:
    """
    Enhanced matching with FINAL SEASON support.
    
    FINAL SEASON Logic:
    - If subtitle has "FINAL SEASON" and season=1 (default), infer season from video
    - If video has "FINAL SEASON" and season=1 (default), infer season from subtitle
    - Only applies when detected season is 1 (the default fallback)
    - Episode numbers must still match for pairing
    """
    # Extract episode info from both files
    sub_info = extract_episode_info(subtitle_file)
    vid_info = extract_episode_info(video_file)
    
    # Check for "FINAL SEASON" keyword
    sub_has_final = detect_final_season_keyword(subtitle_file)
    vid_has_final = detect_final_season_keyword(video_file)
    
    # Case 1: Subtitle has "FINAL SEASON" but no detected season (defaults to S01)
    if sub_has_final and sub_info and sub_info[0] == 1 and vid_info:
        # Infer subtitle season from video season
        sub_info = (vid_info[0], sub_info[1])
    
    # Case 2: Video has "FINAL SEASON" but no detected season (defaults to S01)
    elif vid_has_final and vid_info and vid_info[0] == 1 and sub_info:
        # Infer video season from subtitle season
        vid_info = (sub_info[0], vid_info[1])
    
    # Now compare normalized episode strings
    if sub_info and vid_info:
        sub_normalized = normalize_episode_number(*sub_info)
        vid_normalized = normalize_episode_number(*vid_info)
        return sub_normalized == vid_normalized
    
    return False
```

### Example Scenarios

**Scenario 1: Subtitle has FINAL SEASON**
```
Files:
- My.Hero.Academia.S08E01.Toshinori.Yagi.Rising-Origin.1080p.mkv
- [Heroacainarabic] Boku no Hero Academia FINAL SEASON - 01.ass

Processing:
1. Video: extract_episode_info() → (8, 1)
2. Subtitle: extract_episode_info() → (1, 1) [defaults to S01]
3. Subtitle has "FINAL SEASON": True
4. Subtitle season == 1: True (default)
5. Video season available: (8, 1)
6. Inference: Subtitle → (8, 1) [infer S08 from video]
7. Match: S08E01 == S08E01 ✅

Result: Files are matched correctly
```

**Scenario 2: Video has FINAL SEASON**
```
Files:
- My.Hero.Academia.FINAL.SEASON.01.mkv
- Boku no Hero Academia S08E01.ass

Processing:
1. Video: extract_episode_info() → (1, 1) [defaults to S01]
2. Subtitle: extract_episode_info() → (8, 1)
3. Video has "FINAL SEASON": True
4. Video season == 1: True (default)
5. Subtitle season available: (8, 1)
6. Inference: Video → (8, 1) [infer S08 from subtitle]
7. Match: S08E01 == S08E01 ✅

Result: Files are matched correctly
```

**Scenario 3: Both have FINAL SEASON**
```
Files:
- My.Hero.Academia.FINAL.SEASON.01.mkv
- Boku no Hero Academia FINAL SEASON - 01.ass

Processing:
1. Video: extract_episode_info() → (1, 1)
2. Subtitle: extract_episode_info() → (1, 1)
3. Both have "FINAL SEASON": True
4. Both seasons == 1: True
5. No inference (both are defaults)
6. Match: S01E01 == S01E01 ✅

Result: Files matched at S01 (user needs explicit season in one file)
```

### Edge Cases

1. **Both files explicit seasons:** No inference, match normally
   - `S08E01.mkv` + `S08E01.ass` → Match as S08E01 ✅

2. **FINAL SEASON in path/folder:** Ignored (only check filename)
   - `/FINAL SEASON/episode01.mkv` → No inference (path ignored)

3. **Multiple videos different seasons:** Inference per pair
   - `S07E01.mkv` + `FINAL SEASON - 01.ass` → S07E01
   - `S08E01.mkv` + `FINAL SEASON - 01.ass` → S08E01
   - (Subtitles would need to be in same folder or matched individually)

4. **FINAL without SEASON:** No inference
   - `Final.Episode.01.mkv` → No inference (must be "FINAL SEASON")

### Integration with Existing Code

**Location:** `subfast/scripts/common/pattern_engine.py`

**Changes:**
1. Add `detect_final_season_keyword()` function
2. Enhance `match_subtitle_to_video()` with FINAL SEASON logic
3. No changes to EPISODE_PATTERNS list (this is contextual, not a pattern)

**Impact:**
- Minimal: Only affects matching logic when keyword present
- No breaking changes: Existing behavior preserved
- Performance: Minimal (one extra regex check per file)

### Testing Strategy

**Unit Tests:** `tests/test_pattern_engine.py`
- Test keyword detection (positive/negative)
- Test season inference (Case 1, Case 2)
- Test edge cases (both FINAL, both explicit, etc.)

**Integration Tests:** `tests/run_pattern_integration_tests.py`
- Create My Hero Academia test scenario
- Verify correct season inference
- Test multiple episodes

**Real-world Testing:**
- Use actual anime files with FINAL SEASON naming
- Verify CSV report accuracy
- Test with `subfast_rename.py` and `subfast_embed.py`

---

## Project Structure Notes

**Files to Modify:**
- `subfast/scripts/common/pattern_engine.py` - Add FINAL SEASON logic
- `tests/test_pattern_engine.py` - Add unit tests
- `tests/run_pattern_integration_tests.py` - Add integration tests
- `tests/1- Renaming/episode_patterns_guide.md` - Document Pattern 29

**Files to Create:**
- `tests/fixtures/final_season_test_files/` - Test files for FINAL SEASON scenarios

---

## Testing

### Unit Tests

**Test Coverage:**
- `test_detect_final_season_keyword_positive()` - Various formats
- `test_detect_final_season_keyword_negative()` - False positives
- `test_final_season_subtitle_to_video_inference()` - Case 1
- `test_final_season_video_to_subtitle_inference()` - Case 2
- `test_final_season_both_explicit_no_inference()` - Edge case
- `test_final_season_both_final_no_inference()` - Edge case

**Expected Results:**
- All unit tests pass
- No regression in existing tests
- 100% coverage of FINAL SEASON logic

### Integration Tests

**Test Scenario: My Hero Academia S08 + FINAL SEASON**

```
Test Files:
- My.Hero.Academia.S08E01.mkv
- My Hero Academia Academia Final Season - [2].mkv
- [Heroacainarabic] Boku no Hero Academia FINAL SEASON - 01.ass
- [Heroacainarabic] Boku no Hero Academia Season8 Episode2.ass

Expected Behavior:
- Subtitle 01 matches Video S08E01
- Video 02 matches Subtitle 2 S08E02
- CSV report shows S08E01, S08E02 (not S01E01, S01E02)
```

---

## Dev Agent Record

### Agent Model Used
- Claude 3.5 Sonnet (January 2025)

### Debug Log References
- Test failures debugged and fixed:
  - Pattern 30 regex updated to handle multiple separators (dots, spaces, underscores, hyphens)
  - Test cases updated to use valid pattern extractions
  - Pattern count validation updated (25 → 29 → 30)

### Completion Notes
- **Task 1:** `detect_final_season_keyword()` function added to pattern_engine.py with comprehensive docstring and examples
- **Task 2:** `match_subtitle_to_video()` function implemented with bidirectional season inference logic
- **Task 3:** Pattern 30 documented inline in both functions (contextual, not regex)
- **Task 4:** 11 unit tests added (3 detection + 8 matching), all passing
- **Task 5:** Integration test data added to `pattern_definitions.json` with 6 variations covering all scenarios
- **Task 6:** Pattern 30 added to episode_patterns_guide.md with comprehensive examples
- **INTEGRATION:** FINAL SEASON logic fully integrated into subfast_rename.py and subfast_embed.py

**Implementation Highlights:**
- Regex pattern supports multiple separators: `r'final[.\s_-]+season'`
- Inference only applies when detected season is 1 (default fallback)
- Bidirectional: subtitle→video or video→subtitle
- Episode numbers must still match for pairing
- No breaking changes to existing pattern engine

**Integration Approach:**
- Both scripts check for FINAL SEASON keyword before falling back to simple key matching
- When detected, scripts iterate through all potential pairs using `match_subtitle_to_video()`
- Console output clearly indicates when FINAL SEASON inference is used
- Non-breaking: Only activates when keyword detected, existing behavior preserved
- Bidirectional: Handles both subtitle FINAL and video FINAL scenarios

### File List
**Modified:**
- `subfast/scripts/common/pattern_engine.py` - Added 2 new functions (60 lines)
- `subfast/scripts/subfast_rename.py` - Integrated FINAL SEASON matching logic (47 lines)
- `subfast/scripts/subfast_embed.py` - Integrated FINAL SEASON matching logic (43 lines)
- `tests/test_pattern_matching.py` - Added 2 test classes (110 lines)
- `tests/1- Renaming/episode_patterns_guide.md` - Added Pattern 30 documentation (96 lines)
- `tests/fixtures/pattern_definitions.json` - Added Pattern 30 with 6 variations (52 lines)
- `docs/stories/6.7.final-season-contextual-matching.md` - Updated tasks and status

**New Functions:**
- `detect_final_season_keyword(filename: str) -> bool`
- `match_subtitle_to_video(subtitle_file: str, video_file: str) -> Tuple[Optional[str], Optional[str]]`

**Tests Added:**
- `TestFinalSeasonDetection` - 3 tests for keyword detection
- `TestFinalSeasonMatching` - 8 tests for matching logic

**Test Files Generated:**
- `tests/fixtures/pattern_files/pattern_30_FINAL_SEASON/` - 12 test files (6 variations)
  - VAR1-VAR2: My Hero Academia S08 (subtitle FINAL SEASON)
  - VAR3: Attack on Titan S04 (subtitle FINAL SEASON)
  - VAR4-VAR5: Reverse scenarios (video FINAL SEASON)
  - VAR6: Edge case (both FINAL SEASON)

---

## Change Log

### 2025-01-17 - Story Created (Draft)
- **Status**: Created story based on user requirements
- **Pattern 30**: FINAL SEASON contextual matching logic defined
- **Acceptance Criteria**: 6 ACs covering detection, inference, edge cases, and testing
- **Tasks**: 6 tasks covering implementation, testing, and documentation
- **Next**: Ready for development

### 2025-01-17 - Implementation Complete (Ready for Review)
- **Status**: Changed from Approved to **Ready for Review**
- **Tasks 1-4, 6**: Completed successfully (Task 5 deferred)
- **Pattern 30**: Two functions implemented with 11 unit tests (all passing)
- **Documentation**: Comprehensive Pattern 30 guide added to episode_patterns_guide.md
- **Testing**: All FINAL SEASON unit tests passing (11/11)
- **Integration**: Function available but not yet integrated into rename/embed scripts
- **Next**: QA review and integration into main scripts (Task 5)

### 2025-01-17 - Integration Test Data Added
- **Status**: All tasks complete (1-6)
- **Task 5**: Integration test data added to `pattern_definitions.json`
- **Pattern 30**: 6 variations covering all FINAL SEASON scenarios
- **Test Files**: 12 files generated in `pattern_30_FINAL_SEASON/`
- **Coverage**: My Hero Academia S08, Attack on Titan S04, edge cases
- **Next**: QA review, then integrate `match_subtitle_to_video()` into scripts

### 2025-01-17 - FINAL SEASON Logic Integrated into Main Scripts
- **Status**: FULLY INTEGRATED (Ready for Done)
- **subfast_rename.py**: Added FINAL SEASON matching logic (lines 209-255)
- **subfast_embed.py**: Added FINAL SEASON matching logic (lines 551-593)
- **Integration Approach**: 
  - Check if subtitle has FINAL SEASON → iterate videos to find match
  - Check if video has FINAL SEASON → match with subtitle
  - Fallback to existing simple key matching if no FINAL SEASON
- **Behavior**: Non-breaking, only activates when keyword detected
- **Console Output**: Shows "FINAL SEASON inference" messages when logic triggers
- **Next**: QA review and real-world testing with My Hero Academia files

---

## QA Results

(Awaiting QA review)
