# Story 6.5: Fix Movie Mode Bug & Harden Pattern 25

## Status
DONE

## Story
**As a** SubFast user,  
**I want** Movie Mode to activate correctly and Pattern 25 to be more accurate,  
**so that** files are matched reliably without false positives.

## Acceptance Criteria

1. **Movie Mode activates ONLY when total videos = 1 AND total subtitles = 1**
   - Movie Mode does NOT activate with multiple files (even if only 1 remains unmatched)
   - Fix applied to BOTH `subfast_rename.py` AND `subfast_embed.py`

2. **Pattern 25 supports episodes 1-1899**
   - Allows 1-4 digit episode numbers
   - Successfully matches "Show-1080.mkv" → S01E1080 (OnePiece)
   - Successfully matches "Series-264.mkv" → S01E264

3. **Pattern 25 excludes years 1900-2099**
   - Rejects "Movie-2023.mkv" as non-episode
   - Rejects "Show-1900.mkv" as non-episode

4. **Pattern 25 blocks resolution/codec suffixes**
   - Rejects "Movie-1080p.mkv" (resolution with 'p')
   - x264, h265 already excluded by letter prefix

5. **No regression in existing functionality**
   - All 77 pattern integration tests pass
   - Pattern 25 existing test files still match correctly

## Tasks / Subtasks

- [x] Task 1: Fix Movie Mode Activation in subfast_rename.py
  - [x] Change condition from `len(remaining_video_files)` to `len(video_files)`
  - [x] Change condition from `len(remaining_subtitle_files)` to `len(subtitle_files)`
  - [x] Add comment explaining the fix
  - [x] Verify subfast_embed.py already uses correct logic

- [x] Task 2: Harden Pattern 25 Regex
  - [x] Locate Pattern 25 in pattern_engine.py EPISODE_PATTERNS list
  - [x] Update regex to support 1-1899 episodes
  - [x] Add negative lookahead to block alphanumeric suffixes
  - [x] Update lambda extractor for new regex structure
  - [x] Add explanatory comment

- [x] Task 3: Test Pattern 25 Hardening
  - [x] Create test cases for valid episodes (1080, 264, 720, 1899)
  - [x] Create test cases for blocked patterns (1080p, 2023, 1900)
  - [x] Verify all tests pass
  - [x] Run full pattern integration test suite

- [x] Task 4: Validation
  - [x] Run all 77 pattern integration tests
  - [x] Verify Movie Mode behavior
  - [x] Confirm no regression

## Dev Technical Guidance

### Movie Mode Bug Context

**Current Behavior (BUGGY):**
```python
# Line ~343 in subfast_rename.py
remaining_video_files = [v for v in video_files if not pattern_engine.get_episode_number_cached(v)]
remaining_subtitle_files = [s for s in subtitle_files if not pattern_engine.get_episode_number_cached(s)]

if renamed_count == 0 and len(remaining_video_files) == 1 and len(remaining_subtitle_files) == 1:
    # BUG: Activates even with 10+ original files!
```

**Problem:** 
- Checks `remaining_*` files (files without patterns)
- Activates if remaining = 1 each, regardless of total count
- Example: Folder with 10 videos, 9 have patterns → remaining = 1 → Movie Mode activates! ❌

**Fix:**
```python
# Use TOTAL count, not remaining count
if renamed_count == 0 and len(video_files) == 1 and len(subtitle_files) == 1:
    # Only activates with truly single video + single subtitle ✅
```

### Pattern 25 Hardening

**Current Pattern (Too Permissive):**
```python
# Pattern 25: - # format
(
    '- ##',
    re.compile(r'-\s*(\d+)'),
    lambda m: (1, int(m.group(1)))
),
```

**Problems:**
- Matches years: "Movie-2023.mkv" → Episode 2023 ❌
- Matches resolutions: "Show-1080p.mkv" → Episode 108 (partial) ❌
- No upper limit for episode numbers

**Hardened Pattern:**
```python
# Pattern 25: - # format (assumes Season 1)
# Hardened: Episodes 1-1899 only, excludes years 1900+, blocks letter suffixes
(
    '- ##',
    re.compile(r'-\s*(?:1[0-8]\d{2}|\d{1,3})(?![a-zA-Z0-9])'),
    lambda m: (1, int(m.group(0).split('-')[1].strip()))
),
```

**Regex Breakdown:**
- `(?:1[0-8]\d{2}|\d{1,3})` - Matches 1-1899:
  - `\d{1,3}` → Episodes 1-999
  - `1[0-8]\d{2}` → Episodes 1000-1899
- `(?![a-zA-Z0-9])` - Negative lookahead: NO alphanumeric after digits
  - Blocks: 1080p, 720p, 2023, 1900+
  - Allows: spaces, `-`, `/`, `.`, end of string

### Files to Modify

1. **subfast/scripts/subfast_rename.py** (Line ~348)
2. **subfast/scripts/common/pattern_engine.py** (Pattern 25)

### Testing Strategy

**Test Cases:**
```python
# Valid episodes
"Show - 1080.mkv"     → S01E1080 ✅
"OnePiece - 264.mkv"  → S01E264  ✅
"Series - 720.mkv"    → S01E720  ✅
"Anime - 1899.mkv"    → S01E1899 ✅

# Should be blocked
"Movie - 1080p.mkv"   → NO MATCH ✅ (letter suffix)
"Video - 2023.mkv"    → NO MATCH ✅ (year > 1899)
"Show - 1900.mkv"     → NO MATCH ✅ (year)
```

## Testing

### Pattern 25 Hardening Tests
- Valid episodes 1-1899: PASS ✅
- Blocks resolutions (1080p, 720p): PASS ✅
- Blocks years (1900-2099): PASS ✅
- Blocks codec patterns: PASS ✅

### Integration Tests
- All 77 pattern variations: PASS ✅
- Pattern 25 existing files: PASS ✅
- No regression: PASS ✅

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (2024-10-22)

### Implementation Notes

**Movie Mode Fix:**
- Changed line 348 in subfast_rename.py
- Verified subfast_embed.py already correct (uses total count)
- Added explanatory comment

**Pattern 25 Hardening:**
- Updated regex in pattern_engine.py
- Added `(?![a-zA-Z0-9])` negative lookahead to prevent partial matches
- Lambda updated to handle new regex structure
- Tested with 11 edge cases - all pass

**Testing:**
- Created temporary test script for validation
- All 77 pattern integration tests pass
- Pattern 25 hardening: 11/11 tests pass
- No regression detected

### Debug Log References

**Pattern 25 Test Results:**
```
Pattern 25 Hardening Tests
======================================================================
Show - 1080.mkv                -> S01E1080     | Expected: S01E1080     | PASS
OnePiece - 264.mkv             -> S01E264      | Expected: S01E264      | PASS
Series - 720.mkv               -> S01E720      | Expected: S01E720      | PASS
Anime - 1899.mkv               -> S01E1899     | Expected: S01E1899     | PASS
Show - 5.mkv                   -> S01E05       | Expected: S01E05       | PASS
Example - 100.mkv              -> S01E100      | Expected: S01E100      | PASS
Movie - 1080p.mkv              -> NO MATCH     | Expected: NO MATCH     | PASS
Video - 720p.mkv               -> NO MATCH     | Expected: NO MATCH     | PASS
Show - 1900.mkv                -> NO MATCH     | Expected: NO MATCH     | PASS
Movie - 2023.mkv               -> NO MATCH     | Expected: NO MATCH     | PASS
Film - 2024.mkv                -> NO MATCH     | Expected: NO MATCH     | PASS
======================================================================
Results: 11 PASSED | 0 FAILED
```

**Integration Tests:**
```
Total Patterns Tested:  25
Total Variations:       77
Passed:                 77 (100.0%)
Failed:                 0 (0.0%)
```

### Completion Notes

- Movie Mode bug fixed - now correctly checks total file count
- Pattern 25 hardened to support OnePiece-style long episode numbers (1000+)
- Pattern 25 excludes years and resolution/codec patterns
- All acceptance criteria met
- Zero regression in existing functionality
- All tests passing

### File List

**Modified:**
- `subfast/scripts/subfast_rename.py` - Movie Mode fix (line 348)
- `subfast/scripts/common/pattern_engine.py` - Pattern 25 hardening

**Verified (No Changes Needed):**
- `subfast/scripts/subfast_embed.py` - Already using correct Movie Mode logic

## Change Log

| Date | Version | Change | Author |
|------|---------|--------|--------|
| 2025-01-16 | 1.0 | Story created and implemented | Developer (James) |
| 2025-01-16 | 1.1 | All tasks complete, tests passing | Developer (James) |
| 2025-01-16 | 1.2 | Story file created, marked complete | Developer (James) |
