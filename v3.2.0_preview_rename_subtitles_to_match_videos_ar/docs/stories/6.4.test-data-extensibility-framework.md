# Story 6.4: Test Data Management & Extensibility Framework

## Status
Draft

## Story
**As a** SubFast developer,  
**I want** well-organized test data, reusable fixtures, and a clear extensibility framework,  
**so that** maintaining tests is straightforward and adding new pattern tests requires minimal effort.

## Acceptance Criteria

1. Test data is well-organized and documented in `tests/fixtures/`
2. Fixtures are reusable across test modules
3. **Pattern test cases easily extensible via JSON update**
4. Test setup/teardown helpers available in `test_helpers.py`
5. **Reset script restores pristine test environment**
6. Manual testing can be repeated cleanly
7. **Clear 5-step workflow documented for adding new patterns**
8. New patterns require NO code changes (data-driven)
9. Test data maintenance is straightforward and documented
10. Template and examples provided for pattern additions

## Tasks / Subtasks

- [ ] Task 1: Organize fixtures directory structure (AC: 1, 2)
  - [ ] Verify `tests/fixtures/` directory exists
  - [ ] Create subdirectory structure:
    - `tests/fixtures/pattern_files/` - Dummy pattern test files
    - `tests/fixtures/config_samples/` - Sample config.ini files for testing
    - `tests/fixtures/csv_samples/` - Sample CSV reports for validation
  - [ ] Create `tests/fixtures/README.md` explaining structure
  - [ ] Document what each subdirectory contains
  - [ ] Add .gitkeep files if needed for empty directories

- [ ] Task 2: Create pattern_definitions.json structure (AC: 3, 8)
  - [ ] Define JSON schema for pattern definitions
  - [ ] Include fields: id, name, description, regex, variations, expected results
  - [ ] Add comments/documentation within JSON
  - [ ] Make structure extensible for future fields
  - [ ] Validate JSON is properly formatted
  - [ ] Link to pattern_engine.py for consistency

- [ ] Task 3: Create test_helpers.py utilities (AC: 4, 5)
  - [ ] Create `tests/test_helpers.py` with shared utilities:
    - `create_temp_directory()` - Temporary test workspace
    - `cleanup_temp_directory()` - Remove test artifacts
    - `create_sample_config()` - Generate test config.ini
    - `load_pattern_definitions()` - Read JSON patterns
    - `assert_file_exists(path)` - Custom assertion
    - `assert_files_equal(path1, path2)` - Compare files
    - `reset_test_environment()` - Call reset script
  - [ ] Add comprehensive docstrings for each helper
  - [ ] Include usage examples in docstrings
  - [ ] Ensure all helpers use pathlib.Path

- [ ] Task 4: Create extensibility guide (AC: 7, 10)
  - [ ] Create `tests/ADDING_NEW_PATTERNS.md` with:
    - **Introduction:** Why extensibility matters
    - **5-Step Workflow:** Complete process for adding patterns
    - **Step-by-step details:** What to do in each step
    - **Pattern Template:** Detailed JSON template with explanations
    - **Example:** Adding Pattern 26 walkthrough
    - **Troubleshooting:** Common issues and solutions
    - **Best Practices:** Tips for pattern definitions
    - **Testing:** How to verify new pattern works
  - [ ] Make guide beginner-friendly
  - [ ] Include copy-paste examples

- [ ] Task 5: Create pattern template (AC: 10)
  - [ ] Create `tests/templates/new_pattern_template.json`
  - [ ] Include all required fields with placeholders
  - [ ] Add explanatory comments for each field
  - [ ] Provide realistic example values
  - [ ] Link to ADDING_NEW_PATTERNS.md for guidance

- [ ] Task 6: Document test data maintenance (AC: 9)
  - [ ] Update `tests/fixtures/README.md` with:
    - How to add new test data
    - How to update existing fixtures
    - When to regenerate dummy files
    - How to use reset script
    - File organization principles
  - [ ] Add maintenance checklist
  - [ ] Document dependencies between fixtures

- [ ] Task 7: Create reset workflow documentation (AC: 5, 6)
  - [ ] Document reset script usage in README
  - [ ] Explain when to use reset:
    - After manual testing that modified files
    - Before running tests after failures
    - When debugging test issues
    - For clean environment in CI/CD
  - [ ] Provide usage examples with expected output
  - [ ] Document what gets reset vs. preserved

- [ ] Task 8: Validate extensibility framework (AC: 3, 7, 8)
  - [ ] Add test Pattern 26 to JSON (hypothetical)
  - [ ] Run generate_test_files.py → Files created
  - [ ] Run pattern tests → Pattern 26 automatically tested
  - [ ] Verify NO code changes needed
  - [ ] Time the process → Should be < 10 minutes total
  - [ ] Document any issues encountered

## Dev Notes

### Current System Context

**Existing Test Structure:**
- `tests/1- Renaming/episode_patterns_guide.md` - Pattern specification (EXISTS)
- `tests/2- Embedding/integration_testing_files/` - Real samples (EXISTS)
- `tests/fixtures/` - Will contain organized test data (TO BE CREATED)

**Related Stories:**
- Story 6.1: Created test framework foundation
- Story 6.2: Created pattern_definitions.json and dummy files
- Story 6.3: Will use fixtures for integration testing

### Testing Standards

**Framework:** `unittest` (Python stdlib)

**Test Helpers Usage Example:**
```python
import unittest
from tests.test_helpers import (
    create_temp_directory,
    cleanup_temp_directory,
    load_pattern_definitions
)

class TestMyFeature(unittest.TestCase):
    def setUp(self):
        self.temp_dir = create_temp_directory()
        self.patterns = load_pattern_definitions()
    
    def tearDown(self):
        cleanup_temp_directory(self.temp_dir)
```

### Extensibility Framework Design

**5-Step Workflow for Adding New Patterns:**

**Step 1: Add to pattern_engine.py**
```python
# In EPISODE_PATTERNS list, add new regex pattern
(r'\bNewPattern(\d{2})\b', lambda m: (1, int(m.group(1)))),
```

**Step 2: Update pattern_definitions.json**
```json
{
  "id": 26,
  "name": "NewPattern##",
  "description": "New pattern format description",
  "regex": "\\bNewPattern(\\d{2})\\b",
  "video_variations": [
    "Show.NewPattern05.mkv",
    "Series.NewPattern10.avi"
  ],
  "subtitle_variations": [
    "Show.NewPattern05.srt",
    "Different.NewPattern10.srt"
  ],
  "expected_match": "S01E05",
  "negative_tests": [
    "NewPatternText.mkv",
    "NotANewPattern05.mkv"
  ]
}
```

**Step 3: Generate Files**
```bash
python tests/generate_test_files.py
# Output: Created 3 pattern test files for Pattern 26
```

**Step 4: Run Tests**
```bash
python -m unittest tests.test_pattern_matching
# Pattern 26 automatically tested
```

**Step 5: Update Documentation**
- Add pattern description to `episode_patterns_guide.md`

**Total Time:** < 10 minutes for simple patterns

### Fixtures Organization

**Structure:**
```
tests/fixtures/
├── README.md                      # Fixture documentation
├── pattern_definitions.json       # Pattern specs (Story 6.2)
├── pattern_files/                 # Dummy files organized by pattern
│   ├── pattern_01_S##E##/
│   ├── pattern_02_##x##/
│   └── ... (all 25 patterns)
├── config_samples/                # Sample config files
│   ├── valid_config.ini
│   ├── invalid_config.ini
│   └── minimal_config.ini
└── csv_samples/                   # Sample CSV reports
    ├── empty_report.csv
    └── full_report.csv
```

### Test Helper Functions

**Required Utilities:**

1. **create_temp_directory()** → Path
   - Creates temporary test directory
   - Returns Path object
   - Auto-cleanup on exit

2. **cleanup_temp_directory(path)** → None
   - Removes directory and contents
   - Safe to call multiple times

3. **create_sample_config(path, options={})** → Path
   - Generates test config.ini
   - Customizable options
   - Returns config file path

4. **load_pattern_definitions()** → dict
   - Reads pattern_definitions.json
   - Caches for performance
   - Returns parsed data

5. **assert_file_exists(path, msg=None)** → None
   - Custom assertion for file existence
   - Provides clear error messages

6. **assert_files_equal(path1, path2, msg=None)** → None
   - Compares two files byte-by-byte
   - Useful for output validation

7. **reset_test_environment()** → bool
   - Calls reset_test_files.py script
   - Returns success/failure
   - Logs reset actions

### Documentation Content

**tests/ADDING_NEW_PATTERNS.md Structure:**

1. **Introduction** (Why extensibility?)
2. **Prerequisites** (What you need to know)
3. **The 5-Step Workflow** (High-level overview)
4. **Detailed Step-by-Step Guide**
   - Step 1: Pattern Engine Update
   - Step 2: JSON Definition
   - Step 3: File Generation
   - Step 4: Test Execution
   - Step 5: Documentation Update
5. **Pattern Template Explained**
6. **Example: Adding Pattern 26** (Complete walkthrough)
7. **Troubleshooting**
   - Pattern not matching → Check regex
   - Test failing → Verify expected_match
   - Files not generated → Check JSON syntax
8. **Best Practices**
   - Test variations thoroughly
   - Include negative tests
   - Use realistic filenames
9. **Testing Your New Pattern**
10. **Maintenance Tips**

**tests/fixtures/README.md Structure:**

1. **Overview** (What fixtures are for)
2. **Directory Structure** (Organized breakdown)
3. **Pattern Definitions** (How JSON drives tests)
4. **Adding New Fixtures**
5. **Updating Existing Fixtures**
6. **Reset Workflow** (When and how)
7. **Maintenance Checklist**
8. **Dependencies** (What depends on what)

### Success Criteria

- ✅ Fixtures well-organized and documented
- ✅ Test helpers available and documented
- ✅ Extensibility framework operational
- ✅ Clear 5-step workflow documented
- ✅ Template provides copy-paste structure
- ✅ Reset workflow documented
- ✅ New patterns add with zero code changes
- ✅ Process takes < 10 minutes

## Testing

**Test Validation for This Story:**

1. **Test Helper Validation:**
   - Import all helpers → No errors
   - Create temp directory → Directory exists
   - Cleanup → Directory removed
   - Load pattern definitions → JSON parsed correctly

2. **Documentation Validation:**
   - Read ADDING_NEW_PATTERNS.md → Clear and complete
   - Read fixtures/README.md → Understandable
   - Review template → All fields explained

3. **Extensibility Validation:**
   - Add test Pattern 26 to JSON
   - Run generate_test_files.py → Files created
   - Run tests → Pattern 26 tested automatically
   - Time process → < 10 minutes
   - No code changes needed → Confirmed

4. **Reset Validation:**
   - Modify some test files manually
   - Run reset script → Files restored
   - Verify all fixtures present → Complete

**Manual Verification:**
- Read all documentation → Clear for new developer
- Try adding Pattern 26 → Process smooth
- Check fixtures organization → Logical structure
- Review helper docstrings → Usage clear

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| [Current Date] | 1.0 | Initial story creation from Epic 6 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent during implementation_

### Debug Log References
_To be populated by Dev Agent during implementation_

### Completion Notes List
_To be populated by Dev Agent during implementation_

### File List
_To be populated by Dev Agent during implementation_

## QA Results
_To be populated by QA Agent after implementation review_
