# Story 6.4: Test Data Management & Extensibility Framework

## Status
In Progress

## Story
**As a** SubFast developer,  
**I want** a clear pattern extensibility framework with templates and helpers,  
**so that** adding new episode naming patterns is quick and requires no code changes.

## Acceptance Criteria

1. **Pattern template JSON provides copy-paste structure for new patterns**
2. **Pattern validation helper verifies new pattern definitions are correct**
3. **Pattern test file generator creates dummy files for new patterns automatically**
4. **Clear 5-step workflow documented for adding new patterns** (already exists in ADDING_NEW_PATTERNS.md)
5. New patterns require NO code changes to test suite (data-driven via JSON)
6. **Reset script restores pristine test environment** (already implemented)
7. Process to add new pattern takes < 10 minutes total
8. Helper functions documented with usage examples
9. Pattern template includes explanatory comments and realistic examples
10. Framework validated by adding test Pattern 26 as proof-of-concept

## Tasks / Subtasks

- [x] Task 1: Create pattern template JSON (AC: 1, 9)
  - [ ] Create `tests/templates/` directory if not exists
  - [ ] Create `tests/templates/new_pattern_template.json`
  - [ ] Include all required fields matching pattern_definitions.json schema:
    - id, name, description, variations array
    - Each variation: var_id, expected, video_template, subtitle_template
  - [ ] Add explanatory comments for each field using JSON comments or separate markdown
  - [ ] Provide realistic placeholder values (e.g., "[PATTERN_ID]", "[PATTERN_NAME]")
  - [ ] Include example variation with actual values
  - [ ] Reference ADDING_NEW_PATTERNS.md for complete workflow

- [x] Task 2: Add pattern validation helper (AC: 2, 8)
  - [ ] Add to `tests/test_helpers.py`:
    - `validate_pattern_definition(pattern_dict) -> tuple[bool, list[str]]`
      - Validates JSON structure matches schema
      - Checks required fields present
      - Verifies var_id uniqueness
      - Returns (is_valid, error_messages)
  - [ ] Add comprehensive docstring with usage example
  - [ ] Include validation rules:
    - Pattern ID is unique
    - All required fields present
    - Variation templates are valid filenames
    - Expected format is S##E##
  - [ ] Add unit test for validation helper

- [x] Task 3: Add pattern insertion helper (AC: 3, 5)
  - [ ] Add to `tests/test_helpers.py`:
    - `add_pattern_to_definitions(pattern_dict, json_path=None) -> bool`
      - Reads existing pattern_definitions.json
      - Validates new pattern with validate_pattern_definition()
      - Inserts pattern in correct position (by ID)
      - Writes updated JSON back to file
      - Returns success/failure
  - [ ] Add comprehensive docstring with usage example
  - [ ] Handle edge cases:
    - Duplicate pattern IDs → Error
    - Invalid JSON → Error
    - File backup before modification
  - [ ] Add unit test for insertion helper

- [x] Task 4: Add test file generator helper (AC: 3, 5)
  - [ ] Add to `tests/test_helpers.py`:
    - `generate_pattern_test_files(pattern_id) -> Path`
      - Reads pattern definition from JSON
      - Creates pattern directory (pattern_XX_name/)
      - Generates dummy video and subtitle files
      - Uses generate_test_files.py logic
      - Returns path to created directory
  - [ ] Add comprehensive docstring with usage example
  - [ ] Generate files matching VAR-based structure
  - [ ] Create backup/ subdirectory
  - [ ] Add unit test for generator helper

- [x] Task 5: Update ADDING_NEW_PATTERNS.md with helpers (AC: 4, 8)
  - [ ] Add "Using Helper Functions" section
  - [ ] Document 3-step workflow with helpers:
    1. Copy template → Fill in values
    2. Run validate_pattern_definition()
    3. Run add_pattern_to_definitions() + generate_pattern_test_files()
  - [ ] Include code examples:
    ```python
    from tests.test_helpers import (
        validate_pattern_definition,
        add_pattern_to_definitions,
        generate_pattern_test_files
    )
    
    # Step 1: Create pattern from template
    new_pattern = {...}
    
    # Step 2: Validate
    is_valid, errors = validate_pattern_definition(new_pattern)
    
    # Step 3: Add and generate
    add_pattern_to_definitions(new_pattern)
    generate_pattern_test_files(26)
    ```
  - [ ] Reference template location
  - [ ] Add troubleshooting for common helper errors

- [ ] Task 6: Validate framework with Pattern 26 proof-of-concept (AC: 7, 10)
  - [ ] Create test Pattern 26 definition using template
  - [ ] Use validation helper → Verify it catches errors
  - [ ] Use insertion helper → Add to JSON
  - [ ] Use generator helper → Create test files
  - [ ] Run pattern integration tests → Verify Pattern 26 tested
  - [ ] Time the entire process → Should be < 10 minutes
  - [ ] Document results in story completion notes
  - [ ] Clean up Pattern 26 after validation (or keep as example)

## Dev Notes

### Current System Context

**Already Implemented (Stories 6.1-6.3):**
- ✅ `tests/fixtures/pattern_definitions.json` - VAR-based structure with 25 patterns (647 lines)
- ✅ `tests/test_helpers.py` - Core utilities exist (227 lines)
- ✅ `tests/ADDING_NEW_PATTERNS.md` - 5-step workflow documented (328 lines)
- ✅ `tests/reset_test_files.py` - Reset script working
- ✅ `tests/generate_test_files.py` - File generator exists

**Missing (This Story):**
- ❌ `tests/templates/new_pattern_template.json` - Copy-paste template
- ❌ Pattern validation helper in test_helpers.py
- ❌ Pattern insertion helper in test_helpers.py  
- ❌ Pattern test file generator helper in test_helpers.py
- ❌ Helper usage documentation in ADDING_NEW_PATTERNS.md

### Testing Standards

**Framework:** `unittest` (Python stdlib)

**Test Helpers Usage Example:**
```python
import unittest
from tests.test_helpers import (
    create_temp_directory,
    cleanup_temp_directory,
    load_pattern_definitions
)

class TestMyFeature(unittest.TestCase):
    def setUp(self):
        self.temp_dir = create_temp_directory()
        self.patterns = load_pattern_definitions()
    
    def tearDown(self):
        cleanup_temp_directory(self.temp_dir)
```

### Extensibility Framework Design

**5-Step Workflow for Adding New Patterns:**

**Step 1: Add to pattern_engine.py**
```python
# In EPISODE_PATTERNS list, add new regex pattern
(r'\bNewPattern(\d{2})\b', lambda m: (1, int(m.group(1)))),
```

**Step 2: Update pattern_definitions.json**
```json
{
  "id": 26,
  "name": "NewPattern##",
  "description": "New pattern format description",
  "regex": "\\bNewPattern(\\d{2})\\b",
  "video_variations": [
    "Show.NewPattern05.mkv",
    "Series.NewPattern10.avi"
  ],
  "subtitle_variations": [
    "Show.NewPattern05.srt",
    "Different.NewPattern10.srt"
  ],
  "expected_match": "S01E05",
  "negative_tests": [
    "NewPatternText.mkv",
    "NotANewPattern05.mkv"
  ]
}
```

**Step 3: Generate Files**
```bash
python tests/generate_test_files.py
# Output: Created 3 pattern test files for Pattern 26
```

**Step 4: Run Tests**
```bash
python -m unittest tests.test_pattern_matching
# Pattern 26 automatically tested
```

**Step 5: Update Documentation**
- Add pattern description to `episode_patterns_guide.md`

**Total Time:** < 10 minutes for simple patterns

### Fixtures Organization

**Structure:**
```
tests/fixtures/
├── README.md                      # Fixture documentation
├── pattern_definitions.json       # Pattern specs (Story 6.2)
├── pattern_files/                 # Dummy files organized by pattern
│   ├── pattern_01_S##E##/
│   ├── pattern_02_##x##/
│   └── ... (all 25 patterns)
├── config_samples/                # Sample config files
│   ├── valid_config.ini
│   ├── invalid_config.ini
│   └── minimal_config.ini
└── csv_samples/                   # Sample CSV reports
    ├── empty_report.csv
    └── full_report.csv
```

### Test Helper Functions

**Required Utilities:**

1. **create_temp_directory()** → Path
   - Creates temporary test directory
   - Returns Path object
   - Auto-cleanup on exit

2. **cleanup_temp_directory(path)** → None
   - Removes directory and contents
   - Safe to call multiple times

3. **create_sample_config(path, options={})** → Path
   - Generates test config.ini
   - Customizable options
   - Returns config file path

4. **load_pattern_definitions()** → dict
   - Reads pattern_definitions.json
   - Caches for performance
   - Returns parsed data

5. **assert_file_exists(path, msg=None)** → None
   - Custom assertion for file existence
   - Provides clear error messages

6. **assert_files_equal(path1, path2, msg=None)** → None
   - Compares two files byte-by-byte
   - Useful for output validation

7. **reset_test_environment()** → bool
   - Calls reset_test_files.py script
   - Returns success/failure
   - Logs reset actions

### Documentation Content

**tests/ADDING_NEW_PATTERNS.md Structure:**

1. **Introduction** (Why extensibility?)
2. **Prerequisites** (What you need to know)
3. **The 5-Step Workflow** (High-level overview)
4. **Detailed Step-by-Step Guide**
   - Step 1: Pattern Engine Update
   - Step 2: JSON Definition
   - Step 3: File Generation
   - Step 4: Test Execution
   - Step 5: Documentation Update
5. **Pattern Template Explained**
6. **Example: Adding Pattern 26** (Complete walkthrough)
7. **Troubleshooting**
   - Pattern not matching → Check regex
   - Test failing → Verify expected_match
   - Files not generated → Check JSON syntax
8. **Best Practices**
   - Test variations thoroughly
   - Include negative tests
   - Use realistic filenames
9. **Testing Your New Pattern**
10. **Maintenance Tips**

**tests/fixtures/README.md Structure:**

1. **Overview** (What fixtures are for)
2. **Directory Structure** (Organized breakdown)
3. **Pattern Definitions** (How JSON drives tests)
4. **Adding New Fixtures**
5. **Updating Existing Fixtures**
6. **Reset Workflow** (When and how)
7. **Maintenance Checklist**
8. **Dependencies** (What depends on what)

### Success Criteria

- ✅ Fixtures well-organized and documented
- ✅ Test helpers available and documented
- ✅ Extensibility framework operational
- ✅ Clear 5-step workflow documented
- ✅ Template provides copy-paste structure
- ✅ Reset workflow documented
- ✅ New patterns add with zero code changes
- ✅ Process takes < 10 minutes

## Testing

**Test Validation for This Story:**

1. **Test Helper Validation:**
   - Import all helpers → No errors
   - Create temp directory → Directory exists
   - Cleanup → Directory removed
   - Load pattern definitions → JSON parsed correctly

2. **Documentation Validation:**
   - Read ADDING_NEW_PATTERNS.md → Clear and complete
   - Read fixtures/README.md → Understandable
   - Review template → All fields explained

3. **Extensibility Validation:**
   - Add test Pattern 26 to JSON
   - Run generate_test_files.py → Files created
   - Run tests → Pattern 26 tested automatically
   - Time process → < 10 minutes
   - No code changes needed → Confirmed

4. **Reset Validation:**
   - Modify some test files manually
   - Run reset script → Files restored
   - Verify all fixtures present → Complete

**Manual Verification:**
- Read all documentation → Clear for new developer
- Try adding Pattern 26 → Process smooth
- Check fixtures organization → Logical structure
- Review helper docstrings → Usage clear

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| [Current Date] | 1.0 | Initial story creation from Epic 6 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent during implementation_

### Debug Log References
_To be populated by Dev Agent during implementation_

### Completion Notes List
_To be populated by Dev Agent during implementation_

### File List
_To be populated by Dev Agent during implementation_

## QA Results
_To be populated by QA Agent after implementation review_
