# Story 3.4: Unified Context Menu and Project Structure

## Status
Draft

## Story

As a SubFast user,
I want a single "SubFast" context menu with submenu options for Rename and Embed,
So that my right-click menu is cleaner and the product branding is unified.

## Context

After completing MVP features (renaming and embedding), the product needs:
1. **Unified Branding**: Replace separate context menu entries with single branded menu
2. **Professional Structure**: Organize assets (logo) in proper folder structure
3. **Updated Documentation**: Reflect new structure and SubFast branding

## Acceptance Criteria

1. **AC1**: Resources folder exists containing `subfast_logo.ico`
2. **AC2**: `add_subfast_menu.reg` creates cascading menu: SubFast ‚Üí Rename Subtitles / Embed Subtitles
3. **AC3**: Rename Subtitles appears ABOVE Embed Subtitles in the menu
4. **AC4**: SubFast logo displays next to parent menu item
5. **AC5**: `remove_subfast_menu.reg` cleanly removes all SubFast context menu entries
6. **AC6**: Main README.md created at root level documenting both features and new structure
7. **AC7**: CONFIGURATION_README.md updated with context menu information
8. **AC8**: Old individual registry files marked as deprecated/removed
9. **AC9**: All documentation uses "SubFast" branding consistently

## Dev Technical Guidance

### New Project Structure (Option B - Scalable)

```
subfast/                           # Renamed from rename_subtitles_to_match_videos_ar
‚îú‚îÄ‚îÄ scripts/                       # NEW - Scripts organized
‚îÇ   ‚îú‚îÄ‚îÄ subfast_rename.py         # Renamed from rename_subtitles_to_match_videos_ar.py
‚îÇ   ‚îî‚îÄ‚îÄ subfast_embed.py          # Renamed from embed_subtitles_to_match_videos_ar.py
‚îú‚îÄ‚îÄ bin/                           # NEW - Binary dependencies
‚îÇ   ‚îî‚îÄ‚îÄ mkvmerge.exe
‚îú‚îÄ‚îÄ resources/                     # NEW - Assets folder (lowercase)
‚îÇ   ‚îî‚îÄ‚îÄ subfast_logo.ico          # User will provide
‚îú‚îÄ‚îÄ config.ini                     # Root level for easy access
‚îú‚îÄ‚îÄ add_subfast_menu.reg           # NEW - Unified registry
‚îú‚îÄ‚îÄ remove_subfast_menu.reg        # NEW - Unified removal
‚îú‚îÄ‚îÄ CONFIGURATION_README.md        # Root level
‚îî‚îÄ‚îÄ README.md                      # NEW - Main documentation
```

### Registry Structure (Windows Cascading Menus)

**Parent Menu:**
```registry
[HKEY_CLASSES_ROOT\Directory\Background\shell\SubFast]
"MUIVerb"="SubFast"
"SubCommands"=""
"Icon"="\"%~dp0resources\\subfast_logo.ico\""
```

**Child Menus:**
```registry
[...\SubFast\shell\Rename]
"MUIVerb"="Rename Subtitles"
"Position"="Top"  # Forces Rename above Embed
command\
  @ = "python.exe %~dp0scripts\\subfast_rename.py"

[...\SubFast\shell\Embed]
"MUIVerb"="Embed Subtitles"
command\
  @ = "python.exe %~dp0scripts\\subfast_embed.py"
```

### Key Registry Concepts

- **`SubCommands=""`** ‚Üí Tells Windows to look for child items
- **`Position="Top"`** ‚Üí Forces menu item to top position
- **`%~dp0`** ‚Üí Expands to directory containing .reg file
- **Cascading structure** ‚Üí `shell\{parent}\shell\{child}`

## Tasks / Subtasks

- [x] Task 1: Create organized folder structure (Winston - Architect)
  - [x] Create `scripts/` folder for Python files
  - [x] Create `bin/` folder for mkvmerge.exe
  - [x] Create `resources/` folder for assets
  - [x] Add `README.txt` with icon requirements
  
- [x] Task 2: Create unified registry files (Winston - Architect)
  - [x] Create `add_subfast_menu.reg` with cascading structure
  - [x] Ensure Rename appears above Embed (`Position="Top"`)
  - [x] Add icon reference to Resources folder
  - [x] Create `remove_subfast_menu.reg` for cleanup

- [x] Task 3: Create main README.md (Winston - Architect)
  - [x] Document both features (Rename and Embed)
  - [x] Add installation instructions for context menu
  - [x] Include configuration quick-start
  - [x] Add examples and troubleshooting
  - [x] Use SubFast branding throughout

- [x] Task 4: Update CONFIGURATION_README.md (Winston - Architect)
  - [x] Add context menu structure section
  - [x] Document installation process
  - [x] Note icon location

- [ ] Task 5: Reorganize project files (Dev - James)
  - [ ] Rename main folder from `rename_subtitles_to_match_videos_ar` to `subfast`
  - [ ] Create `scripts/` folder and move Python scripts
  - [ ] Rename `rename_subtitles_to_match_videos_ar.py` to `subfast_rename.py`
  - [ ] Rename `embed_subtitles_to_match_videos_ar.py` to `subfast_embed.py`
  - [ ] Create `bin/` folder and move `mkvmerge.exe`
  - [ ] Rename `Resources/` to `resources/` (lowercase)
  - [ ] Verify all imports still work after rename

- [ ] Task 5b: Place SubFast logo (User)
  - [ ] User to place `subfast_logo.ico` in `resources/` folder
  - [ ] Icon must be .ico format (16x16, 32x32, 48x48, 256x256)

- [ ] Task 6: Test context menu (Dev - James)
  - [ ] Run `add_subfast_menu.reg` as Administrator
  - [ ] Verify SubFast parent menu appears in Explorer
  - [ ] Verify Rename appears ABOVE Embed
  - [ ] Verify icon displays correctly
  - [ ] Test both menu options execute correctly
  - [ ] Run `remove_subfast_menu.reg` and verify clean removal

- [ ] Task 7: Deprecate old registry files (Dev - James)
  - [ ] Delete or move old individual .reg files to archive
  - [ ] Update any references in documentation

- [ ] Task 8: Update architecture docs (Dev - James)
  - [ ] Update/create source tree documentation
  - [ ] Reflect new folder structure
  - [ ] Document context menu implementation

## Testing

### Manual Testing Checklist

**Context Menu Installation:**
- [ ] Right-click `add_subfast_menu.reg` ‚Üí Merge
- [ ] UAC prompt appears (Administrator required)
- [ ] Success message displayed

**Context Menu Verification:**
- [ ] Right-click in any folder
- [ ] "SubFast" menu appears with icon
- [ ] Arrow (‚ñ∫) indicates submenu
- [ ] "Rename Subtitles" appears FIRST
- [ ] "Embed Subtitles" appears SECOND
- [ ] Clicking Rename executes renaming script
- [ ] Clicking Embed executes embedding script

**Context Menu Removal:**
- [ ] Right-click `remove_subfast_menu.reg` ‚Üí Merge
- [ ] Success message displayed
- [ ] SubFast menu no longer appears in Explorer

### Documentation Review

- [ ] README.md is clear and comprehensive
- [ ] CONFIGURATION_README.md accurately describes structure
- [ ] All references to old product name removed
- [ ] "SubFast" branding consistent throughout

## Definition of Done

- [ ] Resources folder created with README.txt
- [ ] `add_subfast_menu.reg` and `remove_subfast_menu.reg` created
- [ ] README.md created with comprehensive documentation
- [ ] CONFIGURATION_README.md updated with context menu info
- [ ] Context menu tested and working (both install and remove)
- [ ] Old registry files removed/archived
- [ ] Documentation updated and consistent
- [ ] User places logo and confirms icon displays

## Notes

**Architect (Winston) Handoff:**
- ‚úÖ Registry files created and documented
- ‚úÖ Resources folder structure established
- ‚úÖ Main README.md created
- ‚úÖ CONFIGURATION_README.md updated
- ‚è≥ Awaiting user to place logo
- ‚è≥ Dev to test and finalize

**Important:**
- User must place `subfast_logo.ico` in `Resources/` folder
- Icon must be .ico format with multiple resolutions
- Registry changes require Administrator privileges
- Old .reg files should be archived, not deleted immediately (for rollback if needed)

## File List

**Created:**
- `subfast/resources/README.txt`
- `subfast/add_subfast_menu.reg`
- `subfast/remove_subfast_menu.reg`
- `subfast/README.md`

**Modified:**
- `subfast/CONFIGURATION_README.md` (updated paths for Option B structure)

**To Be Renamed/Moved (Dev Task 5):**
- Folder: `rename_subtitles_to_match_videos_ar/` ‚Üí `subfast/`
- Script: `rename_subtitles_to_match_videos_ar.py` ‚Üí `scripts/subfast_rename.py`
- Script: `embed_subtitles_to_match_videos_ar.py` ‚Üí `scripts/subfast_embed.py`
- Binary: `mkvmerge.exe` ‚Üí `bin/mkvmerge.exe`
- Folder: `Resources/` ‚Üí `resources/`

**Pending:**
- User to add: `subfast/resources/subfast_logo.ico`
- Dev to deprecate: Old individual .reg files (move to archive)
- Dev to update: Architecture documentation with new structure

---

**Story ready for developer implementation and testing!** üèóÔ∏è

## QA Results

### Review Date: 2025-01-08

### Reviewed By: Quinn (Test Architect)

### Executive Summary

Story 3.4 represents the final pre-shipment milestone for SubFast v3.0.0. **All 9 acceptance criteria have been met** and the implementation is functionally complete and working from any installation location. However, **cleanup is required before production shipment** to remove testing artifacts and ensure a professional release package.

**Overall Assessment:** ‚úÖ **Implementation Complete** | ‚ö†Ô∏è **Cleanup Required**

---

### Acceptance Criteria Validation

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| AC1 | Resources folder with logo | ‚úÖ PASS | resources/subfast_logo.ico (1,864 bytes) + README.txt |
| AC2 | Cascading context menu | ‚úÖ PASS* | Proper SubCommands structure. *CONCERN: .reg hardcoded C:\ (mitigated by .bat installer) |
| AC3 | Rename above Embed | ‚úÖ PASS | 01-Rename/02-Embed ordering confirmed working |
| AC4 | Logo displays | ‚úÖ PASS | User confirmed logo displays correctly |
| AC5 | Clean removal | ‚úÖ PASS | remove_subfast_menu.reg verified correct |
| AC6 | README.md created | ‚úÖ PASS | 7,059 bytes, comprehensive documentation |
| AC7 | CONFIGURATION_README updated | ‚úÖ PASS | 2,491 bytes, context menu documented |
| AC8 | Old files archived | ‚úÖ PASS | archive/ folder with 4 old .reg + README.txt |
| AC9 | SubFast branding | ‚úÖ PASS* | All docs branded correctly. *Old logo file needs deletion |

**Coverage:** 9/9 ACs met (100%)

---

### Deployment Testing Results

**‚úÖ Location Independence Verified:**
- Tested from C:\ dev location: mkvmerge connectivity test PASSED
- Tested from D:\ deployment: User confirmed working after path fix
- config.ini uses relative paths: `bin\mkvmerge.exe` ‚úÖ
- Scripts auto-detect location: `Path(__file__).parent.parent` ‚úÖ

**‚úÖ Context Menu Installation:**
- INSTALL_CONTEXT_MENU.bat: Auto-elevation, file validation, location detection ‚úÖ
- UNINSTALL_CONTEXT_MENU.bat: Clean registry removal ‚úÖ
- User experience: SubFast branding, 10-second auto-close, clear errors ‚úÖ

**‚úÖ Functional Verification:**
- Scripts execute correctly from context menu ‚úÖ
- Menu ordering correct (Rename ‚Üí Embed) ‚úÖ
- Logo displays in Explorer ‚úÖ

---

### Critical Issues Found (Pre-Shipment Cleanup)

#### üö® STRUCT-001: Duplicate `subfast\subfast\` Folder [HIGH]
**Finding:** Testing artifact folder `subfast\subfast\` contains duplicate files  
**Impact:** Confusing for users, unprofessional in distribution package  
**Action Required:** Delete `subfast\subfast\` folder entirely before shipment  
**Owner:** Dev

#### ‚ö†Ô∏è STRUCT-002: Test Files Misplaced [MEDIUM]
**Finding:** Test files in `subfast\` root instead of `subfast\tests\` folder:
- test_embed_subtitles_to_match_videos_ar.py
- test_backup_management.py
- test_batch_processing.py
- test_config_migration.py
- test_file_matching.py

**Action Required:** Move to tests\ folder or delete if obsolete  
**Owner:** Dev

#### ‚ö†Ô∏è REG-001: .reg File Location Limitation [MEDIUM]
**Finding:** `add_subfast_menu.reg` hardcoded to `C:\subfast`  
**Mitigation:** INSTALL_CONTEXT_MENU.bat provides location-independent installation  
**Action Required:** Document in README that .reg is for C:\ only, promote .bat as primary method  
**Owner:** Dev

#### üìù DOC-001: Old Logo File [LOW]
**Finding:** `ARAB_STREAMS_LOGO.ico` (61,055 bytes) still in subfast\ root  
**Action Required:** Delete before shipment (replaced by resources\subfast_logo.ico)  
**Owner:** Dev

---

### Non-Functional Requirements Assessment

**Security:** ‚úÖ PASS
- Registry modifications require Admin privileges (appropriate)
- No hardcoded credentials or security vulnerabilities
- Installation scripts validate files before registry changes

**Reliability:** ‚úÖ PASS
- Error handling in installers is appropriate
- Registry removal is clean and safe
- Scripts work correctly from any installation location

**Performance:** ‚úÖ PASS
- Context menu integration has negligible performance impact
- Scripts execute immediately on selection

**Maintainability:** ‚ö†Ô∏è CONCERNS
- Folder structure is professional (scripts/, bin/, resources/)
- Cleanup needed: duplicate folder and misplaced test files reduce clarity

**Usability:** ‚úÖ PASS (Excellent!)
- Auto-elevation for installers
- SubFast branding throughout
- 10-second auto-close with countdown
- Clear error messages
- Location-independent installation

---

### Files Modified/Verified During Review

**Verified Working:**
- scripts/subfast_embed.py (71,921 bytes) - Path resolution tested ‚úÖ
- scripts/subfast_rename.py (56,292 bytes) - Branding verified ‚úÖ
- bin/mkvmerge.exe (16.4 MB) - Connectivity test passed ‚úÖ
- config.ini (719 bytes) - Relative paths correct ‚úÖ

**Verified Documentation:**
- README.md - SubFast branding throughout ‚úÖ
- CONFIGURATION_README.md - Updated with new structure ‚úÖ
- INSTALLATION_GUIDE.md - Comprehensive install docs ‚úÖ

**Verified Installation:**
- INSTALL_CONTEXT_MENU.bat - Location-independent, tested ‚úÖ
- UNINSTALL_CONTEXT_MENU.bat - Clean removal tested ‚úÖ
- add_subfast_menu.reg - Cascading structure correct ‚ö†Ô∏è (C:\ only)
- remove_subfast_menu.reg - Clean removal verified ‚úÖ

---

### Quality Metrics

**Quality Score:** 70/100
- Base: 100
- Deductions: -10 per CONCERN √ó 3 = -30
- Calculation: 100 - 30 = 70

**Risk Assessment:**
- Critical Risks: 0
- High Risks: 1 (duplicate folder - easy fix)
- Medium Risks: 2 (misplaced tests, .reg limitation)
- Low Risks: 1 (old logo file)

**Test Coverage:**
- Manual Testing: Complete ‚úÖ
- Automated Tests: None (manual testing story)
- User Acceptance: Confirmed working from D:\ deployment ‚úÖ

---

### Gate Status

**Gate:** CONCERNS ‚Üí docs/qa/gates/3.4-unified-context-menu-and-structure.yml

**Status Explanation:**  
Implementation is complete and functionally excellent. All acceptance criteria met. **Gate status is CONCERNS (not FAIL) because:**
- All functionality works correctly ‚úÖ
- All ACs met ‚úÖ  
- Issues are cosmetic/organizational (cleanup items)
- No code changes required
- Quick cleanup can be done in < 30 minutes

**Blockers for PASS:**
1. Remove `subfast\subfast\` duplicate folder
2. Move or delete misplaced test files
3. Delete old logo file
4. Update README to clarify .reg vs .bat installation

---

### Recommended Status

‚ö†Ô∏è **Changes Required** - Cleanup needed before shipment

**Cleanup Checklist:**
- [ ] Delete `subfast\subfast\` duplicate folder (HIGH priority)
- [ ] Move test_*.py files to tests\ or delete (MEDIUM priority)  
- [ ] Delete ARAB_STREAMS_LOGO.ico old logo (LOW priority)
- [ ] Update README: document .reg is C:\ only, promote .bat installer (MEDIUM priority)
- [ ] Optional: Delete/gitignore __pycache__ folder

**After cleanup ‚Üí Ready for Done**

---

### Positive Highlights üåü

**Exceptional Work:**
1. **Location-independent installation** - Works from ANY folder (C:\, D:\, Desktop, etc.)
2. **Professional user experience** - Branding, auto-elevation, smart auto-close
3. **Clean architecture** - Well-organized folder structure (scripts/, bin/, resources/)
4. **Comprehensive documentation** - README, CONFIGURATION_README, INSTALLATION_GUIDE
5. **Backward compatibility** - Old .reg files archived with explanation
6. **User-tested deployment** - Verified working from D:\ by actual user

**Ready for production after cleanup!** This is high-quality work. üéâ

---

### Next Steps

1. **Dev:** Execute cleanup checklist (estimated 20-30 minutes)
2. **Dev:** Update File List in story after cleanup
3. **Dev:** Set Status to "Ready for Review"
4. **QA:** Quick re-verification (5 minutes)
5. **Set to Done** ‚Üí **Ship v3.0.0!** üöÄ
